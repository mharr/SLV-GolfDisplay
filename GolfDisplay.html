<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Golf Winners — Plaque Display</title>
  <meta name="theme-color" content="#000000" />
  <style>
    :root{
      --bg-deep:#060606; --wood1:#2b1a10; --wood2:#4a2c18; --wood3:#6a3a1d;
      --gold1:#d1b264; --gold2:#b9973b; --gold3:#f0d98a; --gold-text:#e8d89a;
      --ink:#fff; --muted:#a9b0bb; --accent:#4ade80;
    }
    html,body{height:100%;margin:0;color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;overflow:hidden}
    body{background:radial-gradient(1200px 700px at 50% 0%,rgba(0,0,0,.45),transparent 60%),linear-gradient(135deg,rgba(0,0,0,.35),rgba(0,0,0,.1)),repeating-linear-gradient(90deg,var(--wood1)0 8px,var(--wood2)8px 16px,var(--wood3)16px 24px);background-blend-mode:multiply,normal,normal}

    .header{position:fixed;inset:0 0 auto 0;display:flex;align-items:center;justify-content:flex-start;padding:14px 20px;background:linear-gradient(180deg,rgba(0,0,0,.45),rgba(0,0,0,0));z-index:5}
    .brand{display:flex;align-items:center;gap:12px}
    .brand img{height:40px;width:auto;object-fit:contain}
    .brand h1{margin:0;font-size:22px;letter-spacing:.3px}
    .sub{font-size:13px;color:var(--muted);margin-top:2px}

    .btn{appearance:none;border:1px solid rgba(255,255,255,.25);background:rgba(0,0,0,.25);color:#fff;padding:10px 18px;border-radius:12px;font-size:16px;cursor:pointer;transition:all .25s ease}
    .btn:hover{border-color:#fff;background:rgba(255,255,255,.15)}
    .btn.go{background:var(--accent);border-color:var(--accent);color:#000;font-weight:700}

    .stage{position:absolute;inset:70px 0 80px 0;display:grid;place-items:center;padding:20px}

    .panelwrap{width:min(1100px,96vw);position:relative}
    .frame{position:relative;padding:26px;border-radius:22px;background:linear-gradient(180deg,rgba(0,0,0,.6),rgba(0,0,0,.1)),repeating-linear-gradient(90deg,var(--wood1)0 10px,var(--wood2)10px 22px,var(--wood3)22px 32px);box-shadow:inset 0 2px 0 rgba(255,255,255,.05),inset 0 -2px 0 rgba(0,0,0,.5),0 30px 120px rgba(0,0,0,.6);border:1px solid rgba(0,0,0,.6)}
    .frame::after{content:"";position:absolute;inset:10px;border-radius:18px;box-shadow:inset 0 2px 6px rgba(0,0,0,.9),inset 0 -1px 0 rgba(255,255,255,.08);pointer-events:none}

    .titlebar{display:flex;align-items:center;justify-content:flex-start;margin:0 6px 14px 6px;height:58px;border-radius:14px;padding:0 18px;background:linear-gradient(180deg,#0e0e0e 0%,#161616 60%,#0c0c0c 100%);box-shadow:inset 0 1px 0 rgba(255,255,255,.08),inset 0 -1px 0 rgba(0,0,0,.7);border:1px solid rgba(0,0,0,.8)}
    .crumbs{font-size:24px;color:var(--gold-text);font-weight:800;letter-spacing:.04em;text-transform:uppercase;text-shadow:0 -1px 0 rgba(0,0,0,.8),0 1px 0 rgba(255,255,255,.07)}

    .plate{position:relative;border-radius:18px;padding:18px;overflow:hidden;background:linear-gradient(145deg,var(--gold2),var(--gold1)35%,var(--gold3)65%,var(--gold2)100%);box-shadow:inset 0 2px 10px rgba(255,255,255,.25),inset 0 -10px 20px rgba(0,0,0,.25),0 12px 50px rgba(0,0,0,.55);border:1px solid #3a2a12}
    .plate::after{content:"";position:absolute;inset:0;pointer-events:none;background:radial-gradient(120% 120% at 50% -10%,rgba(255,255,255,.25),rgba(255,255,255,0)55%),radial-gradient(120% 120% at 50% 120%,rgba(0,0,0,.25),rgba(0,0,0,0)50%);mix-blend-mode:overlay;opacity:.7}
    .screw{position:absolute;width:16px;height:16px;border-radius:50%;background:radial-gradient(circle at 30% 35%,#fff8,#0000 40%),radial-gradient(circle at 70% 65%,#0008,#0000 45%),radial-gradient(circle at 50% 50%,#d8d8d8,#9d9d9d 60%,#6b6b6b 100%);box-shadow:0 1px 0 #000a,inset 0 1px 2px #fff4,inset 0 -1px 2px #0008}
    .screw::after{content:"";position:absolute;left:3px;right:3px;top:50%;height:2px;margin-top:-1px;background:#555;box-shadow:0 1px 0 #111,0 -1px 0 #bbb4}
    .screw.tl{top:12px;left:12px}.screw.tr{top:12px;right:12px}.screw.bl{bottom:12px;left:12px}.screw.br{bottom:12px;right:12px}

    .tablewrap{overflow:auto;border-radius:12px}
    table{width:100%;border-collapse:separate;border-spacing:0;text-align:left;color:#1a1402;font-weight:600}
    thead th{position:sticky;top:0;background:linear-gradient(180deg,#f8eabf,#ead184);color:#3a2a12;border-bottom:1px solid #8b6b23;text-transform:uppercase;font-size:13px;letter-spacing:.08em}
    th,td{padding:12px 16px;border-bottom:1px solid rgba(58,42,18,.35)}
    tbody tr:hover{background:transparent}
    .engrave{color:#3a2a12;text-shadow:0 1px 0 #f6e7b9,0 -1px 0 #745b1b}
    .engrave-soft{color:#4b3716;text-shadow:0 1px 0 #f6e7b9,0 -1px 0 #6a4f1a}

    .footer{position:fixed;inset:auto 0 0 0;text-align:center;padding:10px 12px;color:rgba(255,255,255,.45);font-size:14px;z-index:5}
    .footer-btn{position:fixed;bottom:50px;left:50%;transform:translateX(-50%);z-index:6}

    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.82);backdrop-filter:blur(4px);display:none;z-index:10;padding:24px}
    .panel{max-width:1000px;margin:0 auto;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.18);border-radius:24px;padding:22px 22px 26px 22px;box-shadow:0 30px 160px rgba(0,0,0,.5)}
    .panel-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
    .p-title{font-size:24px;font-weight:700}
    .filters{display:grid;grid-template-columns:1fr 3fr;gap:18px}
    .label{font-size:12px;letter-spacing:2px;text-transform:uppercase;color:rgba(255,255,255,.7);margin-bottom:8px}
    .chipbox{display:flex;flex-wrap:wrap;gap:8px;max-height:46vh;overflow:auto;padding-right:6px}
    .chip{border:1px solid rgba(255,255,255,.35);padding:8px 12px;border-radius:12px;cursor:pointer}
    .chip.active{background:#fff;color:#000;border-color:#fff}

    .fade{opacity:0;transform:translateY(6px);transition:opacity .45s ease,transform .45s ease}
    .fade.show{opacity:1;transform:none}
  </style>
</head>
<body>
  <div class="header">
    <div class="brand">
      <img src="https://savannahlakes.com/image/company_logo?img_id=3407248&t=1760538371938" alt="Savannah Lakes Village Logo"/>
      <div>
        <h1>Club Champions • Digital Plaque</h1>
        <div class="sub" id="nowShowing">&nbsp;</div>
      </div>
    </div>
  </div>

  <div class="stage" id="stage" aria-live="polite"></div>
  <div class="footer-btn"><button class="btn" id="btnFilter">Select Year or League</button></div>
  <div class="footer">Idle returns to auto-rotation of the latest year's leagues</div>

  <div class="overlay" id="overlay" role="dialog" aria-modal="true">
    <div class="panel" onclick="event.stopPropagation()">
      <div class="panel-head">
        <div class="p-title">Choose Year & League</div>
        <div class="actions">
          <button class="btn" id="btnClear">Clear</button>
          <button class="btn go" id="btnApply">Apply</button>
        </div>
      </div>
      <div class="filters">
        <div>
          <div class="label">Year</div>
          <div class="chipbox" id="yearsBox"></div>
        </div>
        <div>
          <div class="label">League</div>
          <div class="chipbox" id="leaguesBox"></div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
  <script>
  // ====== CONFIG ======
  const CONFIG={SHEET_ID:'1dH32Y9dG7471x-2OxXqqzaxjUMytuCtCzOo_8h6cEcc',SHEET_NAME:'Sheet1',SHEET_GID:'',AUTO_ADVANCE_MS:8000,IDLE_TIMEOUT_MS:45000,CROSS_FADE_MS:450,REFRESH_MS:300000};

  // ====== Helpers ======
  const $id=(x)=>document.getElementById(x);
  const log=(...a)=>console.log('[GolfDisplay]',...a);
  const escapeHtml=(s)=>String(s).replace(/[&<>\"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));

  function gvizJsonUrl(){const b=`https://docs.google.com/spreadsheets/d/${CONFIG.SHEET_ID}/gviz/tq?tqx=out:json`;return CONFIG.SHEET_GID? b+`&gid=${encodeURIComponent(CONFIG.SHEET_GID)}`: b+`&sheet=${encodeURIComponent(CONFIG.SHEET_NAME)}`}
  function csvUrl(){const b=`https://docs.google.com/spreadsheets/d/${CONFIG.SHEET_ID}/gviz/tq?tqx=out:csv`;return CONFIG.SHEET_GID? b+`&gid=${encodeURIComponent(CONFIG.SHEET_GID)}`: b+`&sheet=${encodeURIComponent(CONFIG.SHEET_NAME)}`}

  async function fetchGViz(){const url=gvizJsonUrl();log('Fetching GViz JSON',url);const r=await fetch(url,{cache:'no-cache'});if(!r.ok) throw new Error(`HTTP ${r.status} ${r.statusText}`);const txt=await r.text();const s=txt.indexOf('{'),e=txt.lastIndexOf('}');if(s<0||e<0) throw new Error('GViz: unexpected response');const obj=JSON.parse(txt.slice(s,e+1));const cols=(obj.table&&obj.table.cols)||[];const rowsRaw=(obj.table&&obj.table.rows)||[];const headers=cols.map(c=>(c.label||c.id||'').toString().trim().toLowerCase());const out=[];for(const rr of rowsRaw){const row={};(rr.c||[]).forEach((cell,idx)=>row[headers[idx]||`col${idx}`]=(cell&&cell.v!=null)?String(cell.v):'');out.push(row)}return out}
  function splitCSVLine(line){const a=[];let cur='';let q=false;for(let i=0;i<line.length;i++){const ch=line[i];if(ch==='"'){if(q&&line[i+1]==='"'){cur+='"';i++;}else{q=!q}}else if(ch===','&&!q){a.push(cur);cur=''}else{cur+=ch}}a.push(cur);return a}
  function parseCSV(text){const lines=text.replace(/\r/g,'').split('\n').filter(Boolean);if(!lines.length) return [];const headers=splitCSVLine(lines[0]).map(h=>h.trim().toLowerCase());const out=[];for(let i=1;i<lines.length;i++){const cols=splitCSVLine(lines[i]);const row={};headers.forEach((h,idx)=>row[h]=(cols[idx]||'').trim());out.push(row)}return out}
  function normalize(rows){return rows.map(r=>({year:(r.year||'').toString().trim(),league:(r.league||'').toString().trim(),champion:(r.championname||'').toString().trim(),notes:(r.notes||'').toString().trim()})).filter(r=>r.year&&r.league&&r.champion)}

  // ====== Data State ======
  let RECORDS=[],GROUPS=[],SEL_YEAR='',SEL_LEAGUE='';
  let ROTATION=[],ROT_IDX=0,autoTimer=null,idleTimer=null,pollTimer=null,OVERLAY=false;
  let RECS_SIG='';

  async function loadData(){
    try{
      let rows=[];
      try{rows=await fetchGViz()}catch(e){console.warn('GViz failed:',e)}
      if(!rows.length){const url=csvUrl();log('Fetching CSV fallback',url);const r=await fetch(url,{cache:'no-cache'});if(!r.ok) throw new Error(`CSV HTTP ${r.status} ${r.statusText}`);rows=parseCSV(await r.text())}
      RECORDS=normalize(rows);
      RECS_SIG = recordsSignature(RECORDS);
      console.log('[GolfDisplay] first 3 rows:',RECORDS.slice(0,3));
      if(!RECORDS.length){showError('No usable rows found. Headers must be: Year, League, ChampionName, Notes.');return}
      buildGroups();
      console.log('[GolfDisplay] groups:',GROUPS.length);
      resetToLatestYearRotation();
      startAuto();
      render();
      startPolling();
      runSelfTests();
    }catch(e){showError('Could not load Google Sheet. Check sharing and tab name.\n\nDetails: '+String(e))}
  }

  function showError(msg){const el=$id('stage');if(el){el.innerHTML='<div style="max-width:900px;margin:auto;padding:16px 20px;border:1px solid #f19999;background:rgba(255,0,0,.07);border-radius:12px;color:#ff9e9e;white-space:pre-line">'+escapeHtml(String(msg))+'</div>'}const ns=$id('nowShowing');if(ns) ns.textContent=''}

  function buildGroups(){const map=new Map();for(const r of RECORDS){const k=r.year+'|'+r.league;if(!map.has(k)) map.set(k,{year:r.year,league:r.league,rows:[]});map.get(k).rows.push(r)}GROUPS=Array.from(map.values()).sort((a,b)=>Number(b.year)-Number(a.year)||a.league.localeCompare(b.league))}
  const latestYear=()=>GROUPS.length? Math.max(...GROUPS.map(g=>Number(g.year))).toString():'';
  function buildRotationForYear(y){const ys=String(y);ROTATION=GROUPS.map((g,idx)=>({g,idx})).filter(x=>x.g.year===ys).sort((a,b)=>a.g.league.localeCompare(b.g.league)).map(x=>x.idx);ROT_IDX=0}
  function resetToLatestYearRotation(){SEL_YEAR=latestYear();SEL_LEAGUE='';buildRotationForYear(SEL_YEAR)}

  function startAuto(){clearInterval(autoTimer);autoTimer=setInterval(nextSlide,CONFIG.AUTO_ADVANCE_MS)}
  function stopAuto(){clearInterval(autoTimer)}
  function nextSlide(){if(OVERLAY) return;if(!SEL_LEAGUE&&ROTATION.length){ROT_IDX=(ROT_IDX+1)%ROTATION.length;render(true)}}
  function setIdleTimer(){clearTimeout(idleTimer);idleTimer=setTimeout(()=>{hideOverlay();resetToLatestYearRotation();render(true);startAuto()},CONFIG.IDLE_TIMEOUT_MS)}

  function currentGroup(){if(SEL_YEAR&&SEL_LEAGUE){return GROUPS.find(g=>g.year===SEL_YEAR&&g.league===SEL_LEAGUE)||null}if(!SEL_LEAGUE&&ROTATION.length){return GROUPS[ROTATION[ROT_IDX]]}return GROUPS[0]||null}

  function panelHTML(g){
    let body='';
    for(const r of g.rows){body+=`<tr><td class="engrave-soft">${escapeHtml(r.notes||'')}</td><td class="engrave">${escapeHtml(r.champion)}</td></tr>`}
    return `<div class="panelwrap fade" id="panelwrap"><div class="frame"><div class="titlebar"><div class="crumbs">${escapeHtml(g.league)} — ${escapeHtml(g.year)}</div></div><div class="plate"><div class="screw tl"></div><div class="screw tr"></div><div class="screw bl"></div><div class="screw br"></div><div class="tablewrap"><table><thead><tr><th>Event</th><th>Champion</th></tr></thead><tbody>${body}</tbody></table></div></div></div></div>`;
  }

  function render(withFade=false){
    const g=currentGroup();
    const wrap=$id('stage');
    const ns=$id('nowShowing');
    if(!g){wrap.innerHTML='<div>No data</div>';if(ns) ns.textContent='';return}

    const existing=$id('panelwrap');
    const swap=()=>{wrap.innerHTML=panelHTML(g);requestAnimationFrame(()=>{$id('panelwrap')?.classList.add('show')});};

    if(withFade && existing){
      existing.classList.remove('show');
      setTimeout(swap, CONFIG.CROSS_FADE_MS);
    }else{
      swap();
    }
    if(ns) ns.textContent=`Now Showing: ${g.year} • ${g.league} — ${g.rows.length} ${g.rows.length===1?'entry':'entries'}`;
  }

  const uniq=(a)=>[...new Set(a)];
  function showOverlay(){OVERLAY=true;stopAuto();$id('overlay').style.display='block';renderOverlay()}
  function hideOverlay(){OVERLAY=false;$id('overlay').style.display='none'}

  // ====== Change-detection auto-refresh ======
  function recordsSignature(recs){
    // stable sort + stringify; lightweight xor/djb2 mix for speed
    const sorted=[...recs].sort((a,b)=> Number(a.year)-Number(b.year) || a.league.localeCompare(b.league) || a.notes.localeCompare(b.notes) || a.champion.localeCompare(b.champion));
    const str=JSON.stringify(sorted);
    let h=5381; for(let i=0;i<str.length;i++){ h=((h<<5)+h) ^ str.charCodeAt(i); }
    return (h>>>0).toString(16);
  }
  function startPolling(){ clearInterval(pollTimer); pollTimer=setInterval(checkForUpdates, CONFIG.REFRESH_MS); }
  async function checkForUpdates(){
    try{
      let rows=[]; 
      try{ rows=await fetchGViz(); }catch(_){ rows=[]; }
      if(!rows.length){ const r=await fetch(csvUrl(),{cache:'no-cache'}); if(r.ok){ rows=parseCSV(await r.text()); } }
      const next=normalize(rows);
      const sig=recordsSignature(next);
      if(sig!==RECS_SIG && next.length){
        const prevKey = (SEL_YEAR && SEL_LEAGUE) ? (SEL_YEAR+'|'+SEL_LEAGUE) : '';
        RECORDS=next; RECS_SIG=sig; buildGroups();
        if(prevKey){
          const hasPrev = GROUPS.some(g=> (g.year+'|'+g.league)===prevKey);
          if(!hasPrev){ resetToLatestYearRotation(); }
        }else if(SEL_YEAR && !SEL_LEAGUE){ buildRotationForYear(SEL_YEAR); if(!ROTATION.length) resetToLatestYearRotation(); }
        else { resetToLatestYearRotation(); }
        render(true);
        console.log('[GolfDisplay] Data changed — reloaded');
      }
    }catch(e){ console.warn('Auto-refresh check failed:', e); }
  }

  function renderOverlay(){
    const years=uniq(RECORDS.map(r=>r.year)).sort((a,b)=>Number(b)-Number(a));
    const leaguesAll=uniq(RECORDS.map(r=>r.league)).sort();
    const leaguesOfSelYear=SEL_YEAR? uniq(RECORDS.filter(r=>r.year===SEL_YEAR).map(r=>r.league)).sort():leaguesAll;
    $('#yearsBox').html(years.map(y=>`<button class="chip ${SEL_YEAR===y?'active':''}" data-year="${y}">${y}</button>`).join(''));
    $('#leaguesBox').html(leaguesOfSelYear.map(l=>`<button class="chip ${SEL_LEAGUE===l?'active':''}" data-league="${l}">${l}</button>`).join(''));
    $('#yearsBox .chip').off('click').on('click',function(){ SEL_YEAR=String($(this).data('year')); SEL_LEAGUE=''; renderOverlay(); setIdleTimer(); });
    $('#leaguesBox .chip').off('click').on('click',function(){ SEL_LEAGUE=String($(this).data('league')); $(this).siblings().removeClass('active'); $(this).addClass('active'); setIdleTimer(); });
  }

  (function(){
    loadData();
    // controls
    $id('btnFilter').onclick=showOverlay;
    $id('overlay').onclick=hideOverlay; // clicking backdrop closes
    // direct button handlers (no bubbling required)
    $id('btnApply').onclick=function(e){
      e.stopPropagation();
      hideOverlay();
      if(SEL_YEAR && !SEL_LEAGUE){ buildRotationForYear(SEL_YEAR); startAuto(); }
      else if(SEL_YEAR && SEL_LEAGUE){ stopAuto(); }
      else { resetToLatestYearRotation(); startAuto(); }
      render(true); setIdleTimer();
    };
    $id('btnClear').onclick=function(e){
      e.stopPropagation();
      SEL_YEAR=''; SEL_LEAGUE=''; hideOverlay(); resetToLatestYearRotation(); render(true); startAuto(); setIdleTimer();
    };

    ['click','touchstart','mousemove','keydown','wheel'].forEach(ev=>window.addEventListener(ev,setIdleTimer,{passive:true}))
  })();

  function assert(name,ok){if(!ok) console.error('❌',name); else console.log('✅',name)}
  function runSelfTests(){try{const r1=parseCSV('A,B\n1,2');assert('parseCSV basic',r1.length===1&&r1[0].a==='1'&&r1[0].b==='2');const r2=parseCSV('Name,Notes\n"Smith, John",Hello');assert('parseCSV quoted',r2.length===1&&r2[0].name==='Smith, John');const n1=normalize([{year:'2024',league:'MGA',championname:'Alex',notes:'LG'}]);assert('normalize strict',n1.length===1&&n1[0].champion==='Alex');const n2=normalize([{year:'2024',league:'MGA',champion:'Bob'}]);assert('normalize reject wrong key',n2.length===0);const recs=[{year:'2025',league:'MGA',champion:'A',notes:''},{year:'2025',league:'Senior',champion:'B',notes:''},{year:'2024',league:'MGA',champion:'C',notes:''}],map=new Map();for(const r of recs){const k=r.year+'|'+r.league;if(!map.has(k)) map.set(k,{year:r.year,league:r.league,rows:[]});map.get(k).rows.push(r)}const groups=Array.from(map.values()).sort((a,b)=>Number(b.year)-Number(a.year)||a.league.localeCompare(b.league));const y=groups.length?Math.max(...groups.map(g=>Number(g.year))).toString():'';const rot=groups.map((g,idx)=>({g,idx})).filter(x=>x.g.year===y).sort((a,b)=>a.g.league.localeCompare(b.league)).map(x=>x.idx);assert('rotation latest year',y==='2025'&&rot.length===2);assert('escapeHtml',escapeHtml('<>&"')==='&lt;&gt;&amp;&quot;')}catch(e){console.error('Self-tests failed:',e)}}
  </script>
</body>
</html>
